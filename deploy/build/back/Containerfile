FROM registry.hub.docker.com/library/rust:1.91-alpine AS build_base

WORKDIR /app
RUN apk add --no-cache clang lld musl-dev git openssl-dev libcrypto3 perl


# Prepare the build environment and cache dependencies
RUN mkdir -p libs/api/src && \
  mkdir -p libs/common/src && \
  mkdir -p libs/crd/src && \
  mkdir -p libs/trace/src && \
  mkdir -p libs/controller/src && \
  mkdir -p apps/server/src && \
  mkdir -p apps/crdgen/src && \
  mkdir -p apps/swaggergen/src && \
  mkdir -p apps/kubectl_proxyauth/src

# Copy Cargo.toml files
COPY Cargo.toml .
COPY libs/api/Cargo.toml libs/api/Cargo.toml
COPY libs/common/Cargo.toml libs/common/Cargo.toml
COPY libs/crd/Cargo.toml libs/crd/Cargo.toml
COPY libs/trace/Cargo.toml libs/trace/Cargo.toml
COPY libs/controller/Cargo.toml libs/controller/Cargo.toml
COPY apps/server/Cargo.toml apps/server/Cargo.toml
COPY apps/crdgen/Cargo.toml apps/crdgen/Cargo.toml
COPY apps/swaggergen/Cargo.toml apps/swaggergen/Cargo.toml
COPY apps/kubectl_proxyauth/Cargo.toml apps/kubectl_proxyauth/Cargo.toml
COPY .cargo .

# Create dummy file.rs files to allow cargo to make cache
RUN echo "fn main() {}" > libs/api/src/lib.rs && \
  echo "fn main() {}" > libs/common/src/lib.rs && \
  echo "fn main() {}" > libs/crd/src/lib.rs && \
  echo "fn main() {}" > libs/trace/src/lib.rs && \
  echo "fn main() {}" > libs/controller/src/lib.rs && \
  echo "fn main() {}" > apps/server/src/main.rs && \
  echo "fn main() {}" > apps/crdgen/src/main.rs && \
  echo "fn main() {}" > apps/swaggergen/src/main.rs && \
  echo "fn main() {}" > apps/kubectl_proxyauth/src/main.rs

## Build dependencies
RUN cargo build --release --workspace

COPY . .

# Build the actual binary
FROM build_base AS build_back

ENV RUSTFLAGS="-C target-feature=-crt-static"

RUN touch apps/server/src/main.rs && \
  cargo build --release --workspace && \
  strip dist/target/release/server && \
  strip dist/target/release/crdgen && \
  strip dist/target/release/swaggergen && \
  strip dist/target/release/kubectl_proxyauth

# Final stage
FROM registry.hub.docker.com/library/alpine:3.22

RUN apk add --no-cache libgcc && apk upgrade --no-cache

WORKDIR /app

COPY --from=build_back /app/dist/target/release/server /app/server
COPY --from=build_back /app/dist/target/release/crdgen /app/crdgen
COPY --from=build_back /app/dist/target/release/swaggergen /app/swaggergen
COPY --from=build_back /app/dist/target/release/kubectl_proxyauth /app/kubectl-proxyauth

EXPOSE 5437

ENV SERVER_PORT 5437
ENV ENV production

CMD ["/app/server"]
