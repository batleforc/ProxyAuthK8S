version: '3'

includes:
  talos: .taskfile/talos.yaml
  lab: .taskfile/lab.yaml

dotenv:
  - .env

tasks:
  init:
    desc: "Initialize the project"
    silent: true
    cmds:
      - echo "Initializing the project"
      - cog install-hook -a -o
  run:
    desc: "Run the backend"
    env:
      KUBECONFIG: ./kubeconfig.local.yaml
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://localhost:5081/api/default"
      OTEL_EXPORTER_OTLP_HEADERS: "Authorization=Basic cm9vdEBleGFtcGxlLmNvbTpBaU9hZHozNHp6RHdWSHkw,organization=default,stream-name=default"
      REDIS_URL: redis://:{{ .REDIS_PASSWORD }}@localhost:6379/prorxyauthk8s
    silent: true
    cmds:
      - echo "Running the backend"
      - cargo run --bin server
  gen:crds:
    desc: "Generate Custom Resource Definitions"
    silent: true
    cmds:
      - cargo run --bin crdgen
  gen:swagger:
    desc: "Generate Swagger documentation"
    silent: true
    cmds:
      - cargo run --bin swaggergen
  run:service:
    desc: "Run the service task"
    silent: true
    cmds:
      - echo "Running the service task"
      - echo "Traefik Dashboard https://traefik.k8s.localhost/dashboard/"
      # check if neither docker nor podman is installed
      - |
        if ! command -v docker >/dev/null && ! command -v podman >/dev/null; then
          echo "Neither docker nor podman is installed. Please install one of them to run the service."
          exit 1
        fi
      - command -v docker && PUID="$(id -u)" PGID="$(id -g)" docker compose up || true
      - command -v podman && PUID="$(id -u)" PGID="$(id -g)"  podman compose up || true
  recu:
    desc: "Run all gen jobs"
    silent: true
    cmds:
      - task gen:crds > deploy/crds.yaml
      - task gen:swagger > swagger.json