version: "3"

tasks:
  tls:
    desc: "Generate self-signed TLS certificates for local development"
    silent: true
    cmds:
      - echo "Generating self-signed TLS certificates for local development"
      - mkdir -p .tls
      - mkcert -key-file .tls/key.pem -cert-file .tls/cert.pem 127.0.0.1 localhost
  tls-wildcard:
    desc: "Generate self-signed wildcard TLS certificates for local development"
    silent: true
    cmds:
      - echo "Generating self-signed wildcard TLS certificates for local development"
      - mkdir -p .compose/traefik/certs
      - mkcert -key-file .compose/traefik/certs/key.pem -cert-file .compose/traefik/certs/cert.pem '*.k8s.localhost' k8s.localhost
  crds:
    desc: "Generate Custom Resource Definitions"
    silent: true
    cmds:
      - cargo run --bin crdgen
  swagger:
    desc: "Generate Swagger documentation"
    silent: true
    cmds:
      - cargo run --bin swaggergen
  crds-file:
    desc: "Generate Custom Resource Definitions and save to file"
    silent: true
    cmds:
      - task gen:crds > deploy/crds.yaml
      - cp deploy/crds.yaml deploy/chart-crd/templates/crds.yaml
  swagger-file:
    desc: "Generate Swagger documentation and save to file"
    silent: true
    cmds:
      - task gen:swagger > swagger.json
  client:
    desc: "Generate Node and Rust API Clients from OpenAPI specification"
    silent: true
    deps:
      - api-client
      - back-api-client
  back-api-client:
    desc: "Generate backend API client from OpenAPI specification"
    silent: true
    vars:
      RUST_VERSION:
        sh: cat apps/server/Cargo.toml | grep 'version' | head -1 | cut -d '"' -f2
    cmds:
      - echo "Generating backend API client from OpenAPI specification"
      - npx @openapitools/openapi-generator-cli generate -i ./swagger.json -g rust -o./libs/client_api
      - cargo clippy --fix --lib -p client_api --allow-dirty
  api-client:
    desc: "Generate API client from OpenAPI specification"
    silent: true
    vars:
      RUST_VERSION:
        sh: cat apps/server/Cargo.toml | grep 'version' | head -1 | cut -d '"' -f2
    cmds:
      - echo "Generating API client from OpenAPI specification"
      - yarn openapi-ts
